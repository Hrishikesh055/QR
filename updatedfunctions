from flask import Flask, request,send_file
import io
import pyqrcode
import png
from pyqrcode import QRCode
from PIL import Image
import requests
import qrcode
# ...
app = Flask(__name__)
def QR(url):
    qr = qrcode.QRCode(
        version=1,
        error_correction=qrcode.constants.ERROR_CORRECT_L,
        box_size=10,
        border=4,
        )
        # url = pyqrcode.create(s)
        # print(s)
    qr.add_data(url)
    qr.make(fit=True)
    return qr

def QR_color(qr,front_color,back_color):
     qr_img = qr.make_image(fill_color=front_color, back_color=back_color)
     return qr_img
def QR_logo(qr_img,logo_url):
    logo_path = logo_url
    print(logo_path)
        # logo = Image.open(logo_path)
    logo = Image.open(requests.get(logo_path, stream=True).raw)

    # taking base width and adjusting image size
    basewidth = 50
    wpercent = (basewidth / float(logo.size[0]))
    hsize = int((float(logo.size[1]) * float(wpercent)))
    logo = logo.resize((basewidth, hsize), Image.ANTIALIAS)
    pos = ((qr_img.size[0] - logo.size[0]) // 2, (qr_img.size[1] - logo.size[1]) // 2)
    qr_img.paste(logo, pos)
    return qr_img

@app.route('/', methods=['POST'])
def process_json():
    content_type = request.headers.get('Content-Type')
    if (content_type == 'application/json'):
        json = request.json
        url=json['url']
        front_color=back_color=logo_url=None
        if 'front_color' not in json:
            front_color="black"
        else:
            front_color=json['front_color']
        print(front_color)
        if 'back_color' not in json:
            back_color="white"
        else:
            back_color=json['back_color']
        logo_url=json['logo_url']
        qr= QR(url)
        qr_img= QR_color(qr,front_color,back_color)
        image=QR_logo(qr_img,logo_url)


        img = io.BytesIO()
        image.save(img, 'PNG')
        img.seek(0)
        return send_file(img, mimetype='image/png')
    else:
        return 'Content-Type not supported!'
if __name__ == "__main__":
    app.run(debug=True)
